version: "3"

tasks:
  # ========== å†…éƒ¨å·¥å…·ä»»åŠ¡ ==========

  get-default-branch:
    desc: "è·å–é»˜è®¤åˆ†æ”¯åç§°"
    silent: true
    internal: true
    cmds:
      - |
        _branch=$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@' || echo "main")
        echo $_branch

  ensure-clean:
    desc: "ç¡®ä¿å·¥ä½œåŒºå¹²å‡€ï¼Œå¦åˆ™é€€å‡º"
    silent: true
    internal: true
    cmds:
      - |
        if ! git diff --quiet || ! git diff --cached --quiet || [ -n "$(git ls-files --others --exclude-standard)" ]; then
          echo "âš ï¸  æ£€æµ‹åˆ°æœªæäº¤çš„æ›´æ”¹ï¼Œè¯·å…ˆæäº¤æˆ– stash åå†æ‰§è¡Œ"
          exit 1
        fi

  # ========== å…¬å…±ä»»åŠ¡ ==========

  pre-commit:install:
    desc: "å®‰è£… pre-commit é’©å­"
    silent: true
    cmds:
      - |
        [ -f .git/hooks/pre-commit ] && cat .git/hooks/pre-commit | grep -c pre-commit >/dev/null || (command -v pre-commit >/dev/null && pre-commit install)

  push:
    desc: "æš‚å­˜ã€æäº¤å¹¶æ¨é€æ‰€æœ‰æ›´æ”¹"
    summary: |
      å¿«é€Ÿæäº¤å¹¶æ¨é€æ‰€æœ‰æ›´æ”¹åˆ°è¿œç¨‹ä»“åº“

      æ‰§è¡Œæµç¨‹:
        1. å®‰è£… pre-commit é’©å­ï¼ˆå¦‚æœå·²é…ç½®ï¼‰
        2. æš‚å­˜æ‰€æœ‰æ›´æ”¹ (git add --all)
        3. æ˜¾ç¤ºå·¥ä½œåŒºçŠ¶æ€
        4. æäº¤æ›´æ”¹ï¼ˆå¦‚æœ‰æ”¹åŠ¨ï¼‰
        5. æ¨é€åˆ°è¿œç¨‹ä»“åº“

      æäº¤æ¶ˆæ¯:
        - å¯ä»¥é€šè¿‡å‚æ•°æŒ‡å®š: task git:push "ä¿®å¤bug"
        - ä¸æŒ‡å®šæ—¶è‡ªåŠ¨ç”Ÿæˆ: "chore YYYY-MM-DD HH:MM:SS CST"

      ç¤ºä¾‹:
        task git:push                 # ä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„æ¶ˆæ¯
        task git:push "æ·»åŠ æ–°åŠŸèƒ½"     # ä½¿ç”¨è‡ªå®šä¹‰æ¶ˆæ¯
    vars:
      TIME_NOW:
        sh: echo "chore $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S %Z')"
    cmds:
      - task: pre-commit:install
      - |
        git add --all
        git status
        git diff --cached --quiet || git commit -m '{{.CLI_ARGS | default .TIME_NOW}}'
        git push

  tag:
    desc: "åˆ—å‡ºæ‰€æœ‰ Git æ ‡ç­¾ï¼ˆæŒ‰æ—¶é—´æ’åºï¼‰"
    silent: true
    cmds:
      - git tag --sort=creatordate | cat

  tag:next:
    desc: "åˆ›å»ºå¹¶æ¨é€æ–°ç‰ˆæœ¬æ ‡ç­¾ï¼ˆè¯­ä¹‰åŒ–ç‰ˆæœ¬ï¼‰"
    summary: |
      åˆ›å»ºå¹¶æ¨é€è¯­ä¹‰åŒ–ç‰ˆæœ¬æ ‡ç­¾ï¼Œè‡ªåŠ¨æ›´æ–° pyproject.toml å¹¶æäº¤

      ç”¨æ³•:
        task git:tag:next [ç‰ˆæœ¬ç­‰çº§] [æäº¤ä¿¡æ¯]

      å‚æ•°:
        ç‰ˆæœ¬ç­‰çº§: 1=major, 2=minor, 3=patch (é»˜è®¤ 3)
        æäº¤ä¿¡æ¯: å¯é€‰çš„æ ‡ç­¾è¯´æ˜æ–‡å­—

      ç‰ˆæœ¬è§„åˆ™:
        1 = major: ä¸»ç‰ˆæœ¬ (v1.0.0 -> v2.0.0) - ç ´åæ€§å˜æ›´
        2 = minor: æ¬¡ç‰ˆæœ¬ (v1.0.0 -> v1.1.0) - æ–°åŠŸèƒ½
        3 = patch: è¡¥ä¸ (v1.0.0 -> v1.0.1) - bug ä¿®å¤ (é»˜è®¤)

      ç¤ºä¾‹:
        task git:tag:next              # åˆ›å»º v1.0.1
        task git:tag:next 2            # åˆ›å»º v1.1.0
        task git:tag:next 1 "é‡å¤§æ›´æ–°"  # åˆ›å»º v2.0.0

      æ‰§è¡Œæµç¨‹:
        1. æ›´æ–° pyproject.toml ä¸­çš„ç‰ˆæœ¬å·
        2. æäº¤å¹¶æ¨é€æ›´æ”¹
        3. åˆ›å»º annotated tag
        4. æ¨é€ tag åˆ°è¿œç¨‹ä»“åº“
    vars:
      VERSION_LEVEL: '{{index (splitList " " .CLI_ARGS) 0 | default "3"}}'
      TAG_MESSAGE: '{{slice (splitList " " .CLI_ARGS) 1 | join " "}}'
      GIT_TAG_NEXT:
        sh: |
          level="{{.VERSION_LEVEL}}"
          tag="{{.GIT_TAG_LATEST}}"
          # æå–ç‰ˆæœ¬å·éƒ¨åˆ† (å»æ‰ v å‰ç¼€)
          version="${tag#v}"
          IFS='.' read -r major minor patch <<< "$version"
          case "$level" in
            1) echo "v$((major + 1)).0.0" ;;
            2) echo "v${major}.$((minor + 1)).0" ;;
            *) echo "v${major}.${minor}.$((patch + 1))" ;;
          esac
    cmds:
      - echo "{{.GIT_TAG_NEXT}}" | sed -r 's/^v//' | { read ver; sed -r 's|^(version =).*|\1 "'"$ver"'"|' pyproject.toml -i >/dev/null 2>&1; } || true
      - task: push
      - |
        git tag -a {{.GIT_TAG_NEXT}} -m "version bump {{.GIT_TAG_NEXT}}"
        git push origin {{.GIT_TAG_NEXT}}

  fork:sync:internal:
    desc: "å†…éƒ¨ä»»åŠ¡: æ‰§è¡Œä¸Šæ¸¸åŒæ­¥çš„æ ¸å¿ƒé€»è¾‘"
    silent: true
    internal: true
    cmds:
      - |
        # æ£€æŸ¥æ˜¯å¦é…ç½®äº† upstream è¿œç¨‹ä»“åº“
        if ! git remote get-url upstream >/dev/null 2>&1; then
          echo "æœªé…ç½® upstream è¿œç¨‹ä»“åº“ï¼Œè·³è¿‡åŒæ­¥"
          echo "æç¤º: ä½¿ç”¨ 'git remote add upstream <url>' æ·»åŠ ä¸Šæ¸¸ä»“åº“"
          exit 0
        fi

        # ä½¿ç”¨å†…éƒ¨ä»»åŠ¡è·å–é»˜è®¤åˆ†æ”¯
        _default_branch=$(task get-default-branch)

        # ä¿å­˜å½“å‰åˆ†æ”¯å
        _current_branch=$(git branch --show-current)

        # æ£€æŸ¥å·¥ä½œåŒºæ˜¯å¦å¹²å‡€
        task ensure-clean

        # åˆ‡æ¢åˆ°é»˜è®¤åˆ†æ”¯
        git checkout $_default_branch

        # ä» upstream æ‹‰å–å¹¶ rebase
        git pull --rebase upstream $_default_branch

        # æ¨é€åˆ° origin
        git push origin $_default_branch

        echo "âœ… åŒæ­¥å®Œæˆ ($_default_branch)"

        # å°†é»˜è®¤åˆ†æ”¯åä¿å­˜åˆ°ç¯å¢ƒå˜é‡ï¼Œä¾›åç»­ä»»åŠ¡ä½¿ç”¨
        echo $_default_branch > /tmp/task_default_branch
        echo $_current_branch > /tmp/task_current_branch

  fork:sync:
    desc: "ä»ä¸Šæ¸¸åŒæ­¥ä»£ç å¹¶è¿”å›åŸåˆ†æ”¯"
    summary: |
      ä»ä¸Šæ¸¸ä»“åº“ï¼ˆupstreamï¼‰åŒæ­¥æœ€æ–°ä»£ç åˆ°ä½ çš„ forkï¼Œå¹¶è¿”å›å½“å‰åˆ†æ”¯

      å‰ç½®æ¡ä»¶:
        1. å¿…é¡»é…ç½® upstream è¿œç¨‹ä»“åº“
           git remote add upstream <ä¸Šæ¸¸ä»“åº“URL>
        2. å·¥ä½œåŒºå¿…é¡»å¹²å‡€ï¼ˆæ— æœªæäº¤æ›´æ”¹ï¼‰

      æ‰§è¡Œæµç¨‹:
        1. æ£€æŸ¥ upstream æ˜¯å¦é…ç½®
        2. æ£€æŸ¥å·¥ä½œåŒºçŠ¶æ€
        3. åˆ‡æ¢åˆ°é»˜è®¤åˆ†æ”¯ï¼ˆmain/masterï¼‰
        4. ä» upstream æ‹‰å–å¹¶ rebase
        5. æ¨é€åˆ° origin
        6. è¿”å›åŸåˆ†æ”¯

      é…ç½® upstream ç¤ºä¾‹:
        git remote add upstream https://github.com/original/repo.git
    silent: true
    cmds:
      - task: fork:sync:internal
      - |
        _default_branch=$(cat /tmp/task_default_branch 2>/dev/null)
        _current_branch=$(cat /tmp/task_current_branch 2>/dev/null)

        # æ¢å¤åˆ°åŸæ¥çš„åˆ†æ”¯
        if [[ "$_current_branch" != "$_default_branch" ]]; then
          git checkout $_current_branch 2>/dev/null
          echo "ğŸ“ å·²è¿”å›åŸåˆ†æ”¯: $_current_branch"
        fi
        rm -f /tmp/task_default_branch /tmp/task_current_branch

  fork:update:
    desc: "ä»ä¸Šæ¸¸åŒæ­¥å¹¶åˆ›å»ºæ–°åˆ†æ”¯"
    summary: |
      ä»ä¸Šæ¸¸åŒæ­¥æœ€æ–°ä»£ç å¹¶åˆ›å»ºæ–°çš„å¼€å‘åˆ†æ”¯ï¼Œé€‚åˆå¼€å§‹æ–°åŠŸèƒ½å¼€å‘

      å‰ç½®æ¡ä»¶:
        1. å¿…é¡»é…ç½® upstream è¿œç¨‹ä»“åº“
           git remote add upstream <ä¸Šæ¸¸ä»“åº“URL>
        2. å·¥ä½œåŒºå¿…é¡»å¹²å‡€ï¼ˆæ— æœªæäº¤æ›´æ”¹ï¼‰

      æ‰§è¡Œæµç¨‹:
        1. ä» upstream åŒæ­¥æœ€æ–°ä»£ç 
        2. åˆ›å»ºå¸¦æ—¶é—´æˆ³çš„å¼€å‘åˆ†æ”¯ (dev/YYMMDD-HHMM)
        3. ä½ å°†ç›´æ¥è¿›å…¥æ–°åˆ†æ”¯

      ä½¿ç”¨åœºæ™¯:
        - å‡†å¤‡å¼€å§‹æ–°åŠŸèƒ½å¼€å‘
        - éœ€è¦åŸºäºæœ€æ–°çš„ä¸Šæ¸¸ä»£ç 

      ä¸ fork:sync çš„åŒºåˆ«:
        - fork:sync: åŒæ­¥åè¿”å›åŸåˆ†æ”¯
        - fork:update: åŒæ­¥ååˆ›å»ºæ–°åˆ†æ”¯
    silent: true
    cmds:
      - task: fork:sync:internal
      - task: branch:dev

  branch:dev:
    desc: "åˆ›å»ºå¸¦æ—¶é—´æˆ³çš„ä¸´æ—¶å¼€å‘åˆ†æ”¯"
    silent: true
    cmds:
      - |
        _ts=$(date "+%y%m%d-%H%M")
        # ä½¿ç”¨å†…éƒ¨ä»»åŠ¡è·å–é»˜è®¤åˆ†æ”¯
        _default_branch=$(task get-default-branch)
        # åˆ‡æ¢åˆ°é»˜è®¤åˆ†æ”¯
        git checkout $_default_branch
        # åˆ›å»ºä¸´æ—¶åˆ†æ”¯
        git checkout -b "dev/${_ts}"
        echo "âœ… å·²åˆ›å»ºä¸´æ—¶åˆ†æ”¯: dev/${_ts} (åŸºäº $_default_branch)"

  destroy:clear:
    desc: "æ¸…é™¤ Git å†å²ï¼ˆå±é™©æ“ä½œï¼‰"
    summary: |
      âš ï¸  å±é™©æ“ä½œï¼šæ¸…é™¤å½“å‰åˆ†æ”¯çš„æ‰€æœ‰ Git å†å²è®°å½•

      æ­¤æ“ä½œä¼š:
        1. å¤‡ä»½å½“å‰åˆ†æ”¯åˆ° backup/YY/MM/DD/HHMM/<åˆ†æ”¯å>
        2. æ¸…é™¤ Git ç¼“å­˜
        3. åˆ›å»ºå…¨æ–°çš„åˆå§‹æäº¤
        4. å¼ºåˆ¶æ¨é€åˆ°è¿œç¨‹ä»“åº“

      è­¦å‘Š:
        - æ‰€æœ‰å†å²æäº¤è®°å½•å°†è¢«æ¸…é™¤
        - è¿œç¨‹ä»“åº“å†å²å°†è¢«é‡å†™
        - åä½œè€…éœ€è¦é‡æ–°å…‹éš†ä»“åº“
        - æ­¤æ“ä½œä¸å¯é€†

      å¤‡ä»½ä½ç½®:
        æœ¬åœ°åˆ†æ”¯: backup/YY/MM/DD/HHMM/<åŸåˆ†æ”¯å>
        ç¤ºä¾‹: backup/25/01/04/1430/main

      æ¸…ç†å¤‡ä»½:
         task git:destroy:cleanup

      å»ºè®®åœ¨æ‰§è¡Œå‰:
        1. ç¡®è®¤å½“å‰åˆ†æ”¯åç§°
        2. ç¡®ä¿è¿œç¨‹åˆ†æ”¯åç§°æ­£ç¡®
        3. é€šçŸ¥æ‰€æœ‰åä½œè€…
    silent: true
    cmds:
      - |
        _branch_name_current=$(git branch --show-current 2>/dev/null || echo "")
        _branch_name_backup="backup/$(date +'%y/%m/%d/%H%M')/${_branch_name_current}"
        if [[ "${_branch_name_current}" == "" ]]; then
          echo "å½“å‰åˆ†æ”¯ä¸ºç©ºï¼Œè·³è¿‡æ¸…é™¤ git ç¼“å­˜"
          exit 0
        fi
        echo "ğŸ“¦ å¤‡ä»½å½“å‰åˆ†æ”¯åˆ°: ${_branch_name_backup}"
        git add -A && git commit -am "clear commit" --no-verify || true
        git rm -r --cached .
        git branch -m ${_branch_name_backup}
        git checkout --orphan ${_branch_name_current}
        git add -A && git commit -am "clear commit" --no-verify || true
        git push -f origin ${_branch_name_current}
        echo "âœ… å¤‡ä»½åˆ†æ”¯: ${_branch_name_backup}"

  destroy:cleanup:
    desc: "åˆ é™¤æ‰€æœ‰æœ¬åœ°å¤‡ä»½åˆ†æ”¯"
    summary: |
      åˆ é™¤æ‰€æœ‰å¤‡ä»½åˆ†æ”¯ï¼Œé‡Šæ”¾æœ¬åœ°ç©ºé—´

      å¤‡ä»½åˆ†æ”¯å‘½åè§„åˆ™:
        backup/YY/MM/DD/HHMM/<åŸåˆ†æ”¯å>

      ç¤ºä¾‹:
        backup/25/01/04/1430/main
        backup/25/01/03/0912/feature

      æŒ‰æ—¥æœŸæ¸…ç†:
        # æ¸…ç†ç‰¹å®šæ—¥æœŸçš„å¤‡ä»½
        git branch -D $(git branch | grep '^backup/25/01/04/')

      æŒ‰æ—¶é—´æ¸…ç†:
        # æ¸…ç†ç‰¹å®šæ—¶é—´çš„å¤‡ä»½
        git branch -D $(git branch | grep '^backup/25/01/04/1430/')

      æ‰§è¡Œå‰å»ºè®®:
        1. ä½¿ç”¨ git branch | grep backup æŸ¥çœ‹æ‰€æœ‰å¤‡ä»½
        2. ç¡®è®¤ä¸å†éœ€è¦è¿™äº›å¤‡ä»½
    silent: true
    cmds:
      - |
        _backup_branches=$(git branch | grep '^backup/' || true)
        if [[ -z "$_backup_branches" ]]; then
          echo "âœ… æ²¡æœ‰æ‰¾åˆ°å¤‡ä»½åˆ†æ”¯"
          exit 0
        fi
        echo "ğŸ—‘ï¸  å°†åˆ é™¤ä»¥ä¸‹å¤‡ä»½åˆ†æ”¯:"
        echo "$_backup_branches"
        echo ""
        git branch -D $_backup_branches
        echo "âœ… å·²åˆ é™¤æ‰€æœ‰å¤‡ä»½åˆ†æ”¯"

  destroy:reinit:
    desc: "é‡æ–°åˆå§‹åŒ– Git ä»“åº“ï¼ˆå±é™©æ“ä½œï¼‰"
    summary: |
      âš ï¸  æåº¦å±é™©æ“ä½œï¼šå®Œå…¨é‡æ–°åˆå§‹åŒ– Git ä»“åº“

      æ­¤æ“ä½œä¼š:
        1. åˆ é™¤ .git ç›®å½•ï¼ˆæ‰€æœ‰ Git å†å²ï¼‰
        2. é‡æ–°åˆå§‹åŒ– Git ä»“åº“
        3. åˆ›å»ºæ–°çš„åˆå§‹æäº¤
        4. æ·»åŠ æœ€æ–°çš„ git tag
        5. æ¢å¤ remote origin é…ç½®
        6. è°ƒç”¨ destroy:clear æ¸…é™¤è¿œç¨‹å†å²

      è­¦å‘Š:
        - æ‰€æœ‰ Git å†å²å°†æ°¸ä¹…ä¸¢å¤±
        - æ‰€æœ‰åˆ†æ”¯å†å²å°†è¢«æ¸…é™¤
        - æ‰€æœ‰æ ‡ç­¾å°†è¢«åˆ é™¤
        - è¿œç¨‹ä»“åº“å†å²å°†è¢«å®Œå…¨é‡å†™
        - åä½œè€…å¿…é¡»é‡æ–°å…‹éš†
        - æ­¤æ“ä½œä¸å¯é€†

      ä½¿ç”¨åœºæ™¯:
        ä»…åœ¨ä»¥ä¸‹æƒ…å†µè€ƒè™‘ä½¿ç”¨:
        - é¡¹ç›®å®Œå…¨é‡æ–°å¼€å§‹
        - éœ€è¦æ¸…é™¤æ‰€æœ‰æ•æ„Ÿä¿¡æ¯
        - ä»“åº“è¢«ä¸¥é‡ç ´åæ— æ³•æ¢å¤

      æ›¿ä»£æ–¹æ¡ˆ:
        è€ƒè™‘ä½¿ç”¨ git filter-repo æˆ– BFG Repo-Cleaner
        æ¥æ¸…é™¤ç‰¹å®šæ–‡ä»¶æˆ–å†å²ï¼Œè€Œéå®Œå…¨é‡æ–°åˆå§‹åŒ–
    cmds:
      - |
        _remote_url=$(git remote get-url origin | head -n1)
        rm -rf .git
        git init --initial-branch=main
        touch README.md
        git add --all
        git commit -m "first commit" --no-verify || true
        git tag -a {{.GIT_TAG_LATEST}} -m "init"
        git remote add origin ${_remote_url}
        git config push.autoSetupRemote true
      - task: destroy:clear
